name: Docker Image CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    
env:
  VERSION_NUMBER: 7.7.1

jobs:

  build-linux:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2    
    
    - name: Dockerhub Login
      env:
        USERNAME: ${{ secrets.DOCKER_HUB_USER }}
        PASSWORD: ${{ secrets.DOCKER_HUB_PAT }}
      run: docker login --username $USERNAME --password "$PASSWORD"
    
    - name: Build the Docker image      
      run: docker build ./ubuntu-1804 --tag octopuslabs/flyway-workertools:$VERSION_NUMBER-ubuntu.1804 --tag octopuslabs/flyway-workertools:latest-ubuntu.1804
      
    - name: Push the version image
      run: docker push octopuslabs/flyway-workertools:$VERSION_NUMBER-ubuntu.1804
      
    - name: Push the latest image
      run: docker push octopuslabs/flyway-workertools:latest-ubuntu.1804
      
  build-windows:

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2
        
    - name: Dockerhub Login
      env:
        USERNAME: ${{ secrets.DOCKER_HUB_USER }}
        PASSWORD: ${{ secrets.DOCKER_HUB_PAT }}
      run: docker login --username ${env:USERNAME} --password "${env:PASSWORD}"
    
    - name: Build the Docker image
      run: docker build ./windows-2019 --tag octopuslabs/flyway-workertools:${env:VERSION_NUMBER}-windows.2019 --tag octopuslabs/flyway-workertools:latest-windows.2019
      
    - name: Push the version image
      run: docker push octopuslabs/flyway-workertools:${env:VERSION_NUMBER}-windows.2019
      
    - name: Push the latest image
      run: docker push octopuslabs/flyway-workertools:latest-windows.2019
  
  build-docker-manifest:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    
    steps:
    - name: Dockerhub Login
      env:
        USERNAME: ${{ secrets.DOCKER_HUB_USER }}
        PASSWORD: ${{ secrets.DOCKER_HUB_PAT }}
      run: docker login --username $USERNAME --password "$PASSWORD"
      
    - name: Build Manifest
      run: docker manifest create octopuslabs/flyway-workertools:latest octopuslabs/flyway-workertools:latest-windows.2019 octopuslabs/flyway-workertools:latest-ubuntu.1804
      
    - name: Push Manifest
      run: docker manifest push octopuslabs/flyway-workertools:latest
    
